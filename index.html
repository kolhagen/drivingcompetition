<!DOCTYPE html>
<html>
<head>
	<title>Driving Competition</title>

	<meta charset="utf-8" />

	<!-- Load Stylesheets -->
	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">

	<!-- Load Javascript Libraries -->
	<script src="build/react.js"></script>
	<script src="build/JSXTransformer.js"></script>
	<script src="build/jquery-2.1.4.min.js"></script>
	<script src="build/api.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>

	<!-- Load Templates -->
	<script src="templates/driver.js" type="text/jsx"></script>
	<script src="templates/details.js" type="text/jsx"></script>
	<script src="templates/content.js" type="text/jsx"></script>

	<!-- Load Static Data -->
	<script src="data/driver.js"></script>
</head>
<body>
	<h1>Driving Competition</h1>

	<!-- Main Content Container -->
	<div id="container"></div>

	<script type="text/jsx">
		// fill driver w/ random score data
		var FIRST_YEAR = 2014;
		var TODAY = new Date();
		var MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

		for (driver of data.driver) {
			for (var year = FIRST_YEAR; year <= TODAY.getFullYear(); year++) {
				if (!driver.scores[year])
					driver.scores[year] = {};

				var accumulated = 0.0;
				var count = 0;

				for (var month = 1; month <= 12; month++) {
					if (year == TODAY.getFullYear() && month > TODAY.getMonth())
						break;

					if (!driver.scores[year][month])
						driver.scores[year][month] = {};

					if (Math.random() >= 0.2) {
						driver.scores[year][month] = Math.random() * 8.0 + 2.0;

						accumulated += driver.scores[year][month];
						count++;
					} else {
						driver.scores[year][month] = -1;
					}
				}

				driver.scores[year].average = (accumulated / count);
			}
		}

		// calculate ranking based on score
		function calculate(year, month) {
			if (typeof month === 'undefined')
				month = 'average';

			if (year < FIRST_YEAR || year > TODAY.getFullYear() ||
					month !== 'average' && (month < 1 || month > 12 ||
					(year == TODAY.getFullYear() && month > TODAY.getMonth()))) {
				console.error('Invalid Timespan!');
				return;
			}

			console.log("### Before ranking for " + year + "-" + month);
			for (driver of data.driver) {
				console.log(driver.name + ": " + driver.scores[year][month]);
			}

			data.driver.sort(function (driver1, driver2) {
				if (driver1.scores[year][month] === -1 && driver2.scores[year][month] === -1)
					return 0;

				if (driver1.scores[year][month] === -1)
					return driver2.scores[year][month];

				if (driver2.scores[year][month] === -1)
					return -driver1.scores[year][month];

				return driver2.scores[year][month] - driver1.scores[year][month];
			});

			console.log("### After ranking for " + year + "-" + month);
			for (driver of data.driver) {
				console.log(driver.name + ": " + driver.scores[year][month]);
			}
		}

		// calculate trend in rank compared to previous timespan
		function trend(year, month) {
			if (typeof month === 'undefined')
				month = 'average';

			if (year < FIRST_YEAR || year > TODAY.getFullYear() ||
					month !== 'average' && (month < 1 || month > 12 ||
					(year == TODAY.getFullYear() && month > TODAY.getMonth()))) {
				console.error('Invalid Timespan!');
				return;
			}

			if (year == FIRST_YEAR && (
						month === 'average' ||
						month !== 'average' && month == 1)) {
				i = 0;
				for (driver of data.driver) {
					driver.trend = 0;
				}

				calculate(year, month);
			} else {
				var previousMonth;
				var previousYear;
				if (month !== 'average') {
					previousMonth = month - 1;
					previousYear = year;
					if (previousMonth == 0) {
						previousMonth = 12;
						previousYear = year - 1;
					}
				} else {
					previousMonth = month;
					previousYear = year - 1;
				}

				calculate(previousYear, previousMonth);
				var previousRank = {};
				var i = 0;
				for (driver of data.driver) {
					previousRank[driver.name] = i++;
				}

				calculate(year, month);
				i = 0;
				for (driver of data.driver) {
					driver.trend = (previousRank[driver.name] - i++);
				}
			}

			console.log("### Trends");
			for (driver of data.driver) {
				console.log(driver.name + ": " + driver.trend);
			}
		}

		// Render content
		React.render(
			<Content />,
			document.getElementById("container")
		);
	</script>
</body>
</html>
